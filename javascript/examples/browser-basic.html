<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIF Parser - Browser Example</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        textarea {
            width: 100%;
            height: 400px;
            font-family: 'Courier New', monospace;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        .output {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background: #0052a3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>CIF Parser - WebAssembly Demo</h1>
    <p>Parse CIF (Crystallographic Information File) format directly in your browser using WebAssembly.</p>

    <div class="container">
        <div>
            <h2>Input CIF</h2>
            <textarea id="input" placeholder="Paste CIF content here...">data_example
_cell_length_a 10.000
_cell_length_b 20.000
_cell_length_c 30.000
_cell_angle_alpha 90.0
_cell_angle_beta 90.0
_cell_angle_gamma 90.0
_space_group_name_H-M_alt 'P 21 21 21'

loop_
_atom_site_label
_atom_site_type_symbol
_atom_site_fract_x
_atom_site_fract_y
_atom_site_fract_z
C1  C  0.123  0.456  0.789
C2  C  0.234  0.567  0.890
N1  N  0.345  0.678  0.901
O1  O  0.456  0.789  0.012</textarea>
            <button id="parseBtn" onclick="parseCif()">Parse CIF</button>
        </div>

        <div>
            <h2>Output</h2>
            <div id="output" class="output">
                <div class="info">Click "Parse CIF" to see results...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import init, { parse, version } from '../pkg/cif_parser.js';

        let isReady = false;

        async function initialize() {
            try {
                await init();
                isReady = true;
                console.log('CIF Parser WASM initialized, version:', version());
                document.getElementById('parseBtn').disabled = false;
            } catch (error) {
                console.error('Failed to initialize WASM:', error);
                document.getElementById('output').innerHTML =
                    `<div class="error">Failed to initialize WASM module: ${error}</div>`;
            }
        }

        window.parseCif = function() {
            if (!isReady) {
                document.getElementById('output').innerHTML =
                    '<div class="error">WASM module not ready yet...</div>';
                return;
            }

            const input = document.getElementById('input').value;
            const output = document.getElementById('output');

            try {
                const doc = parse(input);

                let html = '<h3>Parse Results</h3>';
                html += `<p><strong>Number of blocks:</strong> ${doc.blockCount}</p>`;
                html += `<p><strong>Block names:</strong> ${doc.blockNames.join(', ')}</p>`;

                // Process first block
                const block = doc.first_block();
                if (block) {
                    html += `<h4>Block: ${block.name}</h4>`;
                    html += `<p><strong>Data items:</strong> ${block.itemKeys.length}</p>`;
                    html += `<p><strong>Loops:</strong> ${block.numLoops}</p>`;

                    // Show some data items
                    html += '<h5>Data Items (sample):</h5><pre>';
                    const items = block.itemKeys.slice(0, 10);
                    for (const key of items) {
                        const value = block.get_item(key);
                        if (value) {
                            if (value.is_numeric()) {
                                html += `${key}: ${value.numeric_value}\n`;
                            } else if (value.is_text()) {
                                html += `${key}: "${value.text_value}"\n`;
                            }
                        }
                    }
                    html += '</pre>';

                    // Show loop data
                    if (block.numLoops > 0) {
                        const loop = block.get_loop(0);
                        html += `<h5>First Loop (${loop.numRows} rows Ã— ${loop.numColumns} columns):</h5>`;
                        html += '<p><strong>Columns:</strong> ' + loop.tags.join(', ') + '</p>';

                        html += '<pre>';
                        const maxRows = Math.min(5, loop.numRows);
                        for (let i = 0; i < maxRows; i++) {
                            const row = loop.get_row_dict(i);
                            html += `Row ${i}: ${JSON.stringify(row, null, 2)}\n`;
                        }
                        if (loop.numRows > 5) {
                            html += `... and ${loop.numRows - 5} more rows\n`;
                        }
                        html += '</pre>';
                    }
                }

                output.innerHTML = html;

            } catch (error) {
                output.innerHTML = `<div class="error"><strong>Parse Error:</strong><br>${error}</div>`;
            }
        };

        // Initialize on load
        document.getElementById('parseBtn').disabled = true;
        initialize();
    </script>
</body>
</html>
